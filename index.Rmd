---
title: "Complaints dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(rio)
library ('plyr')
library(dplyr)
library(tidyverse)
library(plotly)
library(reactable)
```


```{r, include=FALSE}
#install.packages("RPostgreSQL")
#install.packages("RPostgres")
```

```{r, include=FALSE}

library(DBI)

# Obtaining the values of the environment variables

db <- Sys.getenv("db_algorithm")  #database name
db_host <- Sys.getenv("db_host") #localhost
db_port <- Sys.getenv("db_port") #port
db_user <- Sys.getenv("db_user") #credentials: user name
db_pass <- Sys.getenv("db_pass") #credentials: user password


#Connecting to the Postgres database

conn <- dbConnect(
  RPostgres::Postgres(),
  dbname = db,
  host = db_host,
  port = db_port,
  user = db_user,
  password = db_pass
)

```


```{r, include=FALSE}
# import clean claims 21 table 
#clean_claims_21<- dbReadTable(conn, "clean_claims_21")

#keep the last version
#last_version <- max(clean_claims_21$version)

#clean_claims_21 <- clean_claims_21[ clean_claims_21$version == last_version, ]



```


```{r, include=FALSE}
#TEMPORAL: (delete after last commit)
setwd("C:/BID_Columbia/claims_assigment/outputs_temp")

clean_claims_21 <-import("stacking_encoded.dta")

##############
```



```{r, include=FALSE}
### Create a plot with error rate per encoder (Andrea/Edwar) (x axis is for number of batch, y for the error rate)

#keeping just claims reviewed by Jaime
tie_breaking_append <- clean_claims_21[ clean_claims_21$tiebraker_name == "Jaime", ]

#Andrea's number of errors
tie_breaking_append$error_andrea <- rep(0, nrow(tie_breaking_append))
tie_breaking_append$error_andrea[tie_breaking_append$chosen_encoder != "Andrea" & tie_breaking_append$chosen_encoder != "Andrea/Edwar"] <- 1

#Edwar's number of errors
tie_breaking_append$error_edwar <- rep(0, nrow(tie_breaking_append))
tie_breaking_append$error_edwar[tie_breaking_append$chosen_encoder != "Edwar" & tie_breaking_append$chosen_encoder != "Andrea/Edwar"] <- 1

#Number of observartions per batches
df2<- tie_breaking_append %>%
    group_by(date_batch) %>%
    summarise(obs = n()) 

#Number of errors per encoder and batch
df_andrea <- aggregate(tie_breaking_append$error_andrea, by=list(date_batch=tie_breaking_append$date_batch), FUN=sum)

colnames(df_andrea)[2] <- "error_andrea"

df_edwar <- aggregate(tie_breaking_append$error_edwar, by=list(date_batch=tie_breaking_append$date_batch), FUN=sum)

colnames(df_edwar)[2] <- "error_edwar"

#Error rate per encoder and batch
df_error_rate = merge(df2, df_andrea, by = "date_batch", all.x = TRUE)

df_error_rate = merge(df_error_rate, df_edwar, by = "date_batch", all.x = TRUE)


df_error_rate$error_rate_andrea <- round( (df_error_rate$error_andrea/df_error_rate$obs)*100 , 1)

df_error_rate$error_rate_edwar <- round( (df_error_rate$error_edwar/df_error_rate$obs)*100 , 1)


#Error rate per date batch and encoder
df_andrea_rate = df_error_rate[c('date_batch','error_rate_andrea')]

df_edwar_rate = df_error_rate[c('date_batch','error_rate_edwar')]


data_plot <- merge(df_andrea_rate, df_edwar_rate, by = "date_batch")
```



Claims 2021
=====================================  

   
Column {data-width=500}
-------------------------------------

### <b><font face="Arial" size="4px" color="#000000">Plot with error rate per encoder (Andrea/Edwar)</font></b>  


```{r}
#barplot: a plot with error rate per encoder (Andrea/Edwar)
fig <- plot_ly(data_plot, x = ~date_batch, y = ~error_rate_andrea, type = 'bar',  name = 'Andrea',
                marker = list(color = 'rgb(158,202,225)') )
fig <- fig %>% add_trace(y = ~error_rate_edwar, name = 'Edwar',
                marker = list(color = 'springgreen4') )         

fig <- fig %>% 
        layout(title = "",
         xaxis = list(title = "Date batch",
                      zeroline = FALSE),
         yaxis = list(title = "Error rate (%)",
                      zeroline = FALSE))

fig
```


### new tab

```{r, include=FALSE}
#Solving issues with aoc_willay values
clean_claims_21$aoc_willay[clean_claims_21$aoc_willay == ","] <- ""

#from lowercase to uppercase
clean_claims_21 <- mutate_each(clean_claims_21, funs(toupper))

#delete special characters from TIPO_DE_ENTIDAD
clean_claims_21$TIPO_DE_ENTIDAD <- iconv(clean_claims_21$TIPO_DE_ENTIDAD, from="UTF-8",to="ASCII//TRANSLIT")

#Solving some issues with TIPO_DE_ENTIDAD 
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE LA PRODUCCION', 'DIRECCION REGIONAL DE PRODUCCION', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE SALUD DE AREQUIPA', 'DIRECCION REGIONAL DE SALUD AREQUIPA', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE SALUD DE CALLAO', 'DIRECCION REGIONAL DE SALUD CALLAO', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE SALUD DE UCAYALI', 'DIRECCION REGIONAL DE SALUD UCAYALI', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE SALUD DE LA LIBERTAD', 'DIRECCION REGIONAL DE SALUD LA LIBERTAD', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE SALUD DE SAN MARTIN', 'DIRECCION REGIONAL DE SALUD SAN MARTIN', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE TRABAJO Y PROMOCION DE EMPLEO', 'DIRECCION REGIONAL DE TRABAJO Y PROMOCION DEL EMPLEO', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE TRABAJO Y PROMOCION DE EMPLEO', 'DIRECCION REGIONAL DE TRABAJO Y PROMOCION DEL EMPLEO', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE TRANSPORTES', 'DIRECCION REGIONAL DE TRANSPORTE Y COMUNICACIONES', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE TRANSPORTES Y COMUNICACIONES', 'DIRECCION REGIONAL DE TRANSPORTE Y COMUNICACIONES', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE TRANSPORTES Y COMUNICACIONES', 'DIRECCION REGIONAL DE TRANSPORTE Y COMUNICACIONES', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('MINISTERIO DE PRODUCCION', 'MINISTERIO DE LA PRODUCCION', clean_claims_21$TIPO_DE_ENTIDAD)

```

```{r, include=FALSE}
names(clean_claims_21)
```


```{r, include=FALSE}
# number and percentage of denuncias per type of entity
type_entity_count <- subset(clean_claims_21, TIPO_DE_ENTIDAD!= "" ) %>% 
                         count(TIPO_DE_ENTIDAD, sort = TRUE) 

type_entity_count$percentage <- round( (type_entity_count$n/sum(type_entity_count$n) )*100, 1)

type_entity_count

```


```{r, include=FALSE}
#binary measure for whether the claim gets "evaluacion de fondo"
clean_claims_21$assigned_AOC <- ifelse(clean_claims_21$aoc_willay != '', 1, 0)

#claims getting "evaluacion de fondo" per entity
AOC_entity <- subset(clean_claims_21[c("TIPO_DE_ENTIDAD", "assigned_AOC")] , TIPO_DE_ENTIDAD!= "" )

AOC_entity %>% 
   group_by(TIPO_DE_ENTIDAD) %>% summarise_each(funs(sum))

```


```{r}

#delete special characters from TIPO_DENUNCIA_PRIMARIO_14_CLASES
clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES <- iconv(clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES, from="UTF-8",to="ASCII//TRANSLIT")


#Solving some issues with TIPO_DENUNCIA_PRIMARIO_14_CLASES
clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES <- gsub('USO INAPROPIADO DE LOS RECURSOS NO FINANCIEROS', 'USO INAPROPIADO DE RECURSOS NO FINANCIEROS', clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES)

clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES <- gsub('USO INAPROPIADO DE RECURSOS NO FINACIEROS', 'USO INAPROPIADO DE RECURSOS NO FINANCIEROS', clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES)


# number and percentage of denuncias per type of primary class
primary_class_count <- subset(clean_claims_21, TIPO_DENUNCIA_PRIMARIO_14_CLASES!= "" ) %>% 
                         count(TIPO_DENUNCIA_PRIMARIO_14_CLASES, sort = TRUE) 

primary_class_count$percentage <- round( (primary_class_count$n/sum(primary_class_count$n) )*100, 1)

primary_class_count

```


```{r, include=FALSE}

# creating a variable that identifies corruption claims
clean_claims_21$corruption_denunc<- ifelse(clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES=='LUCRO ILEGAL'| clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES=='USO INAPROPIADO DE RECURSOS NO FINANCIEROS'| clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES== 'FAVORITISMO' | clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES== 'COLUSION'| clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES== 'ABUSO DE AUTORIDAD O EXTORSION', 1, 0)

clean_claims_21$corruption_denunc<- ifelse(clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES=='', '', clean_claims_21$corruption_denunc)



```



Column {data-width=500}
-------------------------------------

### <b><font face="Arial" size="4px" color="#000000">Table per encoded variable with the number and percentage of missing observations</font></b>  


```{r, include=FALSE}

#table(clean_claims_21$aoc_willay)

#dataframe with two columns: variable and number of missings

df_missings <- ldply(clean_claims_21, function(var_value) sum(var_value ==""))
colnames(df_missings) <- c("variable", "n_missings")

#adding a new column: percentage of missings obs 
df_missings$percentage_missing = df_missings$n_missings/ nrow(clean_claims_21)
```


```{r}
bar_chart <- function(label, width = "100%", height = "14px", fill = "#00bfc4", background = NULL) {
  bar <- htmltools::div(style = list(background = fill, width = width, height = height))
  chart <- htmltools::div(style = list(flexGrow = 1, marginLeft = "6px", background = background), bar)
  htmltools::div(style = list(display = "flex", alignItems = "center"), label, chart)
}

tbl <- reactable::reactable(df_missings,
                     pagination = FALSE,
                     highlight = TRUE,
                     height = 400,
                     sortable = TRUE,
                     borderless = TRUE,
                     defaultPageSize = nrow(df_missings),
                     defaultSortOrder = "desc",
                     defaultSorted = "percentage_missing",
                     columns = list(
                       variable = reactable::colDef(name = "Variable", minWidth = 50, maxWidth = 100),
                       n_missings = reactable::colDef(name = "Number of missings",  minWidth = 50, maxWidth = 100),
                       percentage_missing = reactable::colDef(name = "% missings",  
                                                      minWidth = 50, maxWidth = 200,
                                                      cell = function(value) {
                                                        # Format as percentages with 1 decimal place
                                                        value <- paste0(format(round(value * 100, 2), nsmall = 1), "%")
                                                        bar_chart(value, width = value, fill = "red", background = "#e1e1e1")
                                                      },
                       align = "left"))
)

tbl
```



Page 2
=====================================  

```{r, include=FALSE}
# import raw_claims_feb21 
raw_claims_feb21 <- dbReadTable(conn, "raw_claims_feb21")
```


```{r, include=FALSE}
names(raw_claims_feb21 )
```






