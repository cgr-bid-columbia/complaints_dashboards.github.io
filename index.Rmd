---
title: "Complaints dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(rio)
library(dplyr)
library(tidyverse)
library(plotly)
```


```{r, include=FALSE}
#install.packages("RPostgreSQL")
#install.packages("RPostgres")
```

```{r, include=FALSE}

#library(DBI)

# Obtaining the values of the environment variables

#db <- Sys.getenv("db_algorithm")  #database name
#db_host <- Sys.getenv("db_host") #localhost
#db_port <- Sys.getenv("db_port") #port
#db_user <- Sys.getenv("db_user") #credentials: user name
#db_pass <- Sys.getenv("db_pass") #credentials: user password


#Connecting to the Postgres database

#conn <- dbConnect(
#  RPostgres::Postgres(),
#  dbname = db,
#  host = db_host,
#  port = db_port,
#  user = db_user,
#  password = db_pass
#)

```


```{r, include=FALSE}
# import clean claims 21 table 
#tie_breaking_append <- dbReadTable(conn, "clean_claims_21")

#keep the last version
#last_version <- max(tie_breaking_append$version)

#tie_breaking_append <- tie_breaking_append[ tie_breaking_append$version == last_version, ]

```


```{r, include=FALSE}

#TEMPORAL: (delete after last commit)
setwd("C:/BID_Columbia/claims_assigment/outputs_temp")

tie_breaking_append <-import("stacking_encoded.dta")

##############

### Create a plot with error rate per encoder (Andrea/Edwar) (x axis is for number of batch, y for the error rate)

#keeping just claims reviewed by Jaime
tie_breaking_append <- tie_breaking_append[ tie_breaking_append$tiebraker_name == "Jaime", ]

#Andrea's number of errors
tie_breaking_append$error_andrea <- rep(0, nrow(tie_breaking_append))
tie_breaking_append$error_andrea[tie_breaking_append$chosen_encoder != "Andrea" & tie_breaking_append$chosen_encoder != "Andrea/Edwar"] <- 1

#Edwar's number of errors
tie_breaking_append$error_edwar <- rep(0, nrow(tie_breaking_append))
tie_breaking_append$error_edwar[tie_breaking_append$chosen_encoder != "Edwar" & tie_breaking_append$chosen_encoder != "Andrea/Edwar"] <- 1

#Number of observartions per batches
df2<- tie_breaking_append %>%
    group_by(date_batch) %>%
    summarise(obs = n()) 

#Number of errors per encoder and batch
df_andrea <- aggregate(tie_breaking_append$error_andrea, by=list(date_batch=tie_breaking_append$date_batch), FUN=sum)

colnames(df_andrea)[2] <- "error_andrea"

df_edwar <- aggregate(tie_breaking_append$error_edwar, by=list(date_batch=tie_breaking_append$date_batch), FUN=sum)

colnames(df_edwar)[2] <- "error_edwar"

#Error rate per encoder and batch
df_error_rate = merge(df2, df_andrea, by = "date_batch", all.x = TRUE)

df_error_rate = merge(df_error_rate, df_edwar, by = "date_batch", all.x = TRUE)


df_error_rate$error_rate_andrea <- round( (df_error_rate$error_andrea/df_error_rate$obs)*100 , 1)

df_error_rate$error_rate_edwar <- round( (df_error_rate$error_edwar/df_error_rate$obs)*100 , 1)


#Error rate per date batch and encoder
df_andrea_rate = df_error_rate[c('date_batch','error_rate_andrea')]

df_edwar_rate = df_error_rate[c('date_batch','error_rate_edwar')]


data_plot <- merge(df_andrea_rate, df_edwar_rate, by = "date_batch")
```

Row {.tabset}
-----------------------------------------------------------------------

### Plot with error rate per encoder (Andrea/Edwar) 

```{r}
#barplot: a plot with error rate per encoder (Andrea/Edwar)
fig <- plot_ly(data_plot, x = ~date_batch, y = ~error_rate_andrea, type = 'bar',  name = 'Andrea',
                marker = list(color = 'rgb(158,202,225)') )
fig <- fig %>% add_trace(y = ~error_rate_edwar, name = 'Edwar',
                marker = list(color = 'springgreen4') )         

fig <- fig %>% 
        layout(title = "",
         xaxis = list(title = "Date batch",
                      zeroline = FALSE),
         yaxis = list(title = "Error rate (%)",
                      zeroline = FALSE))

fig
```


### Another tab

