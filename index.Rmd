---
title: "Complaints dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
---


```{r setup, include=FALSE}
library(flexdashboard)
library(rio)
library ('plyr')
library(dplyr)
library(tidyverse)
library(plotly)
library(reactable)
library(htmltools)
library(ggplot2)
library(ggiraph)
```

```{r}
knitr::opts_chunk$set(fig.width=5, fig.height=3) 
```


```{r, include=FALSE}
#install.packages("RPostgreSQL")
#install.packages("RPostgres")
```

```{r, include=FALSE}

library(DBI)

# Obtaining the values of the environment variables

#db <- Sys.getenv("db_algorithm")  #database name
#db_host <- Sys.getenv("db_host") #localhost
#db_port <- Sys.getenv("db_port") #port
#db_user <- Sys.getenv("db_user") #credentials: user name
#db_pass <- Sys.getenv("db_pass") #credentials: user password


#Connecting to the Postgres database

#conn <- dbConnect(
#  RPostgres::Postgres(),
#  dbname = db,
#  host = db_host,
#  port = db_port,
#  user = db_user,
#  password = db_pass
#)

```


```{r, include=FALSE}
# import clean claims 21 table 
#clean_claims_21<- dbReadTable(conn, "clean_claims_21")

#keep the last version
#last_version <- max(clean_claims_21$version)

#clean_claims_21 <- clean_claims_21[ clean_claims_21$version == last_version, ]



```


```{r, include=FALSE}
#TEMPORAL: (delete after last commit)
setwd("C:/BID_Columbia/claims_assigment/outputs_temp")

clean_claims_21 <-import("stacking_encoded.dta")

##############
```


```{r, include=FALSE}
# import raw_claims_feb21 
#raw_claims_feb21 <- dbReadTable(conn, "raw_claims_feb21")
```


```{r, include=FALSE}
#TEMPORAL: (delete after last commit)
setwd("C:/BID_Columbia")

raw_claims_feb21 <-import("raw_claims_feb21.dta")

##############
```



Claims 2021
=====================================  

## Row
-----------------------------------------------------------------------

### Number of claims {.value-box}

```{r}
n_claims <- nrow(raw_claims_feb21)

valueBox(value = paste(format(n_claims, big.mark = ","), "", sep = " "), 
         caption = "Total Claims",
         icon = "fa-database",             #https://fontawesome.com/v4/icons/
         color = "purple")
```


### Number of encoded claims {.value-box}

```{r}
n_encoded <- nrow(clean_claims_21)
percent_encoded <- paste( round(n_encoded/n_claims,1)*100, "%")

valueBox(value = paste(format(n_encoded, big.mark = ","), "/", percent_encoded  , sep = " "), 
         caption = "Encoded Claims", icon = "fa-arrow-circle-up")
```


### Number of claims that are CGR responsability {.value-box}

```{r}
n_cgr <- sum(raw_claims_feb21$competencia_cgr == 'S')

valueBox(value = paste(format(n_cgr, big.mark = ","), "", sep = " "),
         caption = "Claims that are CGR responsability", icon = "fa-tasks")

```



### Number of claims with simultaneous control {.value-box}

```{r}
n_sc <- sum(raw_claims_feb21$a_control_simultaneo == 'S')

valueBox(value = paste(format(n_sc, big.mark = ","), "", sep = " "), 
         caption = "Claims with Simultaneous Control")#, 
         #color = active_color)
```


## Row
-----------------------------------------------------------------------

### <b><font face="Arial" size="4px" color="#000000">HEC status</font></b>

```{r}
#todo: validate recategorization

# Recategorization for hec status
raw_claims_feb21 <- mutate(raw_claims_feb21, hec_status_re =
                                   case_when(estado_hec == "Calificado" | estado_hec == "Concluido" ~ "Accept",
                                             estado_hec == "Anulado" ~ "Reject",
                                             estado_hec == "En Proceso" | estado_hec == "Pendiente" ~ "Waiting" ) )


#Donut chart: hec status
hec_status_df <- as.data.frame(table(raw_claims_feb21$hec_status_re))

colnames(hec_status_df) <- c("hec_status", "n")
 
fig <- hec_status_df %>% plot_ly(labels = ~hec_status, values = ~n, marker = list(colors = c('#00aa7f', '#ff0000',"#2675fc")))
fig <- fig %>% add_pie(hole = 0.55, textfont = list(size = 13))
fig <- fig %>% layout(showlegend = T,
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig


```


### <b><font face="Arial" size="4px" color="#000000">FUR status</font></b>

```{r}
# Recategorization for fur status
raw_claims_feb21 <- mutate(raw_claims_feb21, ARA_decision =
                                   case_when(estado_fur == "Aceptado a tr치mite" | estado_fur == "Admitido" ~ "Accept",
                                             estado_fur == "Derivado" ~ "Derive",
                                             estado_fur == "Desestimado" | estado_fur == "Devuelto" | estado_fur == "No aceptado a tr치mite" | estado_fur == "No admitido" ~ "Reject",
                                             estado_fur == "En evaluaci칩n" | estado_fur == "Pendiente" ~ "Waiting" ) )


#Donut chart: fur status
fur_status_df <- as.data.frame(table(raw_claims_feb21$ARA_decision))

colnames(fur_status_df) <- c("fur_status", "n")
 
fig <- fur_status_df %>% plot_ly(labels = ~fur_status, values = ~n, marker = list(colors = c('#00aa7f', '#ccccc7','#ff0000', "#2675fc" )))
fig <- fig %>% add_pie(hole = 0.55, textfont = list(size = 13))
fig <- fig %>% layout(showlegend = T,
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```

### <b><font face="Arial" size="4px" color="#000000">FUD status</font></b>

```{r}
# Recategorization for fud status
raw_claims_feb21 <- mutate(raw_claims_feb21, fud_status_re =
                                   case_when(estado_fud == ""  ~ "Missings",
                                             estado_fud == "Derivado" ~ "Derive",
                                             estado_fud == "Asociado" ~ "Associated",
                                             estado_fud == "Devuelto" | estado_fud == "Desestimado" ~ "Reject",
                                             estado_fud == "Sin atender" ~ "Waiting" ) )


#Donut chart: fud status
fud_status_df <- as.data.frame(table(raw_claims_feb21$fud_status_re))

colnames(fud_status_df) <- c("fud_status", "n")
 
fig <- fud_status_df %>% plot_ly(labels = ~fud_status, values = ~n, marker = list(colors = c('#00aa7f', '#ccccc7', '#ff0000', "#2675fc" )))
fig <- fig %>% add_pie(hole = 0.55, textfont = list(size = 13))
fig <- fig %>% layout(showlegend = T,
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig

```



```{r, include=FALSE}

#creating accept claim var based on ARA decision
raw_claims_feb21 <- mutate(raw_claims_feb21, accept_claim =
                                   case_when(ARA_decision == "Accept" ~ 1,
                                             ARA_decision != "Accept" ~ 0 ) )

## PRODUCTS

#binary measure for whether the claim gets "evaluacion de fondo" // todo: una mejor variable es cod_aoc_willay, porque aoc_willay tiene comas (corregir esto en la tabla de abajo de evaluacion de fondo)
raw_claims_feb21$assigned_AOC <- ifelse(raw_claims_feb21$aoc_willay != '', 1, 0)


#creating alarm var 
raw_claims_feb21$alarm<- ifelse(raw_claims_feb21$producto_propuesto=='Carpeta Atenci칩n de Denuncia', 1, NA)
		
```


```{r, include=FALSE}

#BAR PLOT (TODO)

#claims getting "evaluacion de fondo" per UO
AOC_UO <- subset(raw_claims_feb21[c("uo_ara", "assigned_AOC")] , uo_ara!= "" )

AOC_UO_count <- AOC_UO %>% 
                    group_by(uo_ara) %>% summarise_each(funs(sum))

AOC_UO_count
```


```{r, include=FALSE}

#BAR PLOT (TODO)

#claims getting "alertas de control" per UO
AOC_UO <- subset(raw_claims_feb21[c("uo_ara", "alarm")] , alarm!= "" )

AOC_UO_count <- AOC_UO %>% 
                    group_by(uo_ara) %>% summarise_each(funs(sum))

AOC_UO_count
```



## Row
-----------------------------------------------------------------------


### <b><font face="Arial" size="4px" color="#000000">Table per encoded variable with the number and percentage of missing observations</font></b>

```{r, include=FALSE}

#table(clean_claims_21$aoc_willay)

#dataframe with two columns: variable and number of missings

df_missings <- ldply(clean_claims_21, function(var_value) sum(var_value ==""))
colnames(df_missings) <- c("variable", "n_missings")

#adding a new column: percentage of missings obs 
df_missings$percentage_missing = df_missings$n_missings/ nrow(clean_claims_21)
```


```{r}
bar_chart <- function(label, width = "100%", height = "14px", fill = "#00bfc4", background = NULL) {
  bar <- htmltools::div(style = list(background = fill, width = width, height = height))
  chart <- htmltools::div(style = list(flexGrow = 1, marginLeft = "6px", background = background), bar)
  htmltools::div(style = list(display = "flex", alignItems = "center"), label, chart)
}

tbl <- reactable::reactable(df_missings,
                     pagination = FALSE,
                     highlight = TRUE,
                     height = 400,
                     sortable = TRUE,
                     borderless = TRUE,
                     defaultPageSize = nrow(df_missings),
                     defaultSortOrder = "desc",
                     defaultSorted = "percentage_missing",
                     columns = list(
                       variable = reactable::colDef(name = "Variable", minWidth = 50, maxWidth = 100),
                       n_missings = reactable::colDef(name = "Number of missings",  minWidth = 50, maxWidth = 100),
                       percentage_missing = reactable::colDef(name = "% missings",  
                                                      minWidth = 50, maxWidth = 200,
                                                      cell = function(value) {
                                                        # Format as percentages with 1 decimal place
                                                        value <- paste0(format(round(value * 100, 2), nsmall = 1), "%")
                                                        bar_chart(value, width = value, fill = "red", background = "#e1e1e1")
                                                      },
                       align = "left"))
)

tbl
```


### <b><font face="Arial" size="4px" color="#000000">Plot with error rate per encoder (Andrea/Edwar)</font></b>  


```{r, include=FALSE}
### Create a plot with error rate per encoder (Andrea/Edwar) (x axis is for number of batch, y for the error rate)

#keeping just claims reviewed by Jaime
tie_breaking_append <- clean_claims_21[ clean_claims_21$tiebraker_name == "Jaime", ]

#Andrea's number of errors
tie_breaking_append$error_andrea <- rep(0, nrow(tie_breaking_append))
tie_breaking_append$error_andrea[tie_breaking_append$chosen_encoder != "Andrea" & tie_breaking_append$chosen_encoder != "Andrea/Edwar"] <- 1

#Edwar's number of errors
tie_breaking_append$error_edwar <- rep(0, nrow(tie_breaking_append))
tie_breaking_append$error_edwar[tie_breaking_append$chosen_encoder != "Edwar" & tie_breaking_append$chosen_encoder != "Andrea/Edwar"] <- 1

#Number of observartions per batches
df2<- tie_breaking_append %>%
    group_by(date_batch) %>%
    summarise(obs = n()) 

#Number of errors per encoder and batch
df_andrea <- aggregate(tie_breaking_append$error_andrea, by=list(date_batch=tie_breaking_append$date_batch), FUN=sum)

colnames(df_andrea)[2] <- "error_andrea"

df_edwar <- aggregate(tie_breaking_append$error_edwar, by=list(date_batch=tie_breaking_append$date_batch), FUN=sum)

colnames(df_edwar)[2] <- "error_edwar"

#Error rate per encoder and batch
df_error_rate = merge(df2, df_andrea, by = "date_batch", all.x = TRUE)

df_error_rate = merge(df_error_rate, df_edwar, by = "date_batch", all.x = TRUE)


df_error_rate$error_rate_andrea <- round( (df_error_rate$error_andrea/df_error_rate$obs)*100 , 1)

df_error_rate$error_rate_edwar <- round( (df_error_rate$error_edwar/df_error_rate$obs)*100 , 1)


#Error rate per date batch and encoder
df_andrea_rate = df_error_rate[c('date_batch','error_rate_andrea')]

df_edwar_rate = df_error_rate[c('date_batch','error_rate_edwar')]


data_plot <- merge(df_andrea_rate, df_edwar_rate, by = "date_batch")
```


```{r}
#barplot: a plot with error rate per encoder (Andrea/Edwar)
fig <- plot_ly(data_plot, x = ~date_batch, y = ~error_rate_andrea, type = 'bar',  name = 'Andrea',
                marker = list(color = 'rgb(158,202,225)') )
fig <- fig %>% add_trace(y = ~error_rate_edwar, name = 'Edwar',
                marker = list(color = 'springgreen4') )         

fig <- fig %>% 
        layout(title = "",
         xaxis = list(title = "Date batch",
                      zeroline = FALSE),
         yaxis = list(title = "Error rate (%)",
                      zeroline = FALSE))

fig
```

## Row
-----------------------------------------------------------------------

### <b><font face="Arial" size="4px" color="#000000">Corruption claims</font></b>  

```{r, include=FALSE}

# creating a variable that identifies corruption claims
clean_claims_21$corruption_denunc<- ifelse(clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES=='LUCRO ILEGAL'| clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES=='USO INAPROPIADO DE RECURSOS NO FINANCIEROS'| clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES== 'FAVORITISMO' | clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES== 'COLUSION'| clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES== 'ABUSO DE AUTORIDAD O EXTORSION', 1, 0)

clean_claims_21$corruption_denunc<- ifelse(clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES=='', '', clean_claims_21$corruption_denunc)


# number and percentage of corruption claims 
corruption_claims_count <- subset(clean_claims_21, corruption_denunc!= "" ) %>% 
                         count(corruption_denunc, sort = TRUE)

corruption_claims_count$percentage <- round( (corruption_claims_count$n/sum(corruption_claims_count$n) )*100, 1)

corruption_claims_count <- corruption_claims_count %>%
  mutate(
    type = ifelse(corruption_claims_count$corruption_denunc == 1, "Yes", "No"),
    hover_text = paste0(type, ": ", n)
  ) %>%
  mutate(percentage_label = paste0(percentage,"%"))



```


```{r}

donut_plot <- ggplot(corruption_claims_count, aes(y = n, fill = type)) +
  geom_bar_interactive(
    aes(x = 1, tooltip = hover_text),
    width = 0.1,
    stat = "identity",
    show.legend = FALSE
    ) +
  annotate(
    geom = "text",
    x = 0,
    y = 0,
    label = corruption_claims_count[["percentage_label"]][corruption_claims_count[["type"]] == "Yes"],
    size = 18,
    color = "magenta"
    ) +
  scale_fill_manual(values = c(No = "blue", Yes = "magenta")) +
  coord_polar(theta = "y") +
  theme_void()


ggiraph(ggobj = donut_plot, width = 0.3 )
```


## Row
-----------------------------------------------------------------------

### <b><font face="Arial" size="4px" color="#000000">Claims by entity</font></b>  


```{r, include=FALSE}
#Solving issues with aoc_willay values
clean_claims_21$aoc_willay[clean_claims_21$aoc_willay == ","] <- ""

#from lowercase to uppercase
clean_claims_21 <- mutate_each(clean_claims_21, funs(toupper))

#delete special characters from TIPO_DE_ENTIDAD
clean_claims_21$TIPO_DE_ENTIDAD <- iconv(clean_claims_21$TIPO_DE_ENTIDAD, from="UTF-8",to="ASCII//TRANSLIT")

#Solving some issues with TIPO_DE_ENTIDAD 
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE LA PRODUCCION', 'DIRECCION REGIONAL DE PRODUCCION', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE SALUD DE AREQUIPA', 'DIRECCION REGIONAL DE SALUD AREQUIPA', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE SALUD DE CALLAO', 'DIRECCION REGIONAL DE SALUD CALLAO', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE SALUD DE UCAYALI', 'DIRECCION REGIONAL DE SALUD UCAYALI', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE SALUD DE LA LIBERTAD', 'DIRECCION REGIONAL DE SALUD LA LIBERTAD', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE SALUD DE SAN MARTIN', 'DIRECCION REGIONAL DE SALUD SAN MARTIN', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE TRABAJO Y PROMOCION DE EMPLEO', 'DIRECCION REGIONAL DE TRABAJO Y PROMOCION DEL EMPLEO', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE TRABAJO Y PROMOCION DE EMPLEO', 'DIRECCION REGIONAL DE TRABAJO Y PROMOCION DEL EMPLEO', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE TRANSPORTES', 'DIRECCION REGIONAL DE TRANSPORTE Y COMUNICACIONES', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE TRANSPORTES Y COMUNICACIONES', 'DIRECCION REGIONAL DE TRANSPORTE Y COMUNICACIONES', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('DIRECCION REGIONAL DE TRANSPORTES Y COMUNICACIONES', 'DIRECCION REGIONAL DE TRANSPORTE Y COMUNICACIONES', clean_claims_21$TIPO_DE_ENTIDAD)
clean_claims_21$TIPO_DE_ENTIDAD <- gsub('MINISTERIO DE PRODUCCION', 'MINISTERIO DE LA PRODUCCION', clean_claims_21$TIPO_DE_ENTIDAD)

```


```{r}
# number and percentage of denuncias per type of entity
type_entity_count <- subset(clean_claims_21, TIPO_DE_ENTIDAD!= "" ) %>% 
                         count(TIPO_DE_ENTIDAD, sort = TRUE) 

type_entity_count$percentage <- round( (type_entity_count$n/sum(type_entity_count$n) )*100, 1)


# Render a bar chart with a label on the left
bar_chart <- function(label, width = "100%", height = "14px", fill = "#00bfc4", background = NULL) {
  bar <- div(style = list(background = fill, width = width, height = height))
  chart <- div(style = list(flexGrow = 1, marginLeft = "6px", background = background), bar)
  div(style = list(display = "flex", alignItems = "center"), label, chart)
}


tbl <- reactable(
  type_entity_count,
  pagination = TRUE,
  defaultSorted = "n",
  defaultColDef = colDef(headerClass = "header", align = "left"),
  columns = list(
    TIPO_DE_ENTIDAD = colDef(name = "Entity type"
 
    ),
    n = colDef(
      name = "Number of obs",
      defaultSortOrder = "desc",
      # Render the bar charts using a custom cell render function
      cell = function(value) {
        width <- paste0(value * 100 / max(type_entity_count$n), "%")
        # Add thousands separators
        value <- format(value, big.mark = ",")
        bar_chart(value, width = width, fill = "#3fc1c9")
      },
      # And left-align the columns
      align = "left"
    ),
    percentage = colDef(
      name = "Percentage",
      defaultSortOrder = "desc",
      # Render the bar charts using a custom cell render function
      cell = function(value) {
        # Format as percentages with 1 decimal place
        value <- paste0(format(value , nsmall = 1), "%")
        bar_chart(value, width = value, fill = "#fc5185", background = "#e1e1e1")
      },
      # And left-align the columns
      align = "left"
    )
  )
)

tbl

```


### <b><font face="Arial" size="4px" color="#000000">Claims getting "evaluacion de fondo" per entity</font></b>  


```{r}
#binary measure for whether the claim gets "evaluacion de fondo"
clean_claims_21$assigned_AOC <- ifelse(clean_claims_21$aoc_willay != '', 1, 0)

#claims getting "evaluacion de fondo" per entity
AOC_entity <- subset(clean_claims_21[c("TIPO_DE_ENTIDAD", "assigned_AOC")] , TIPO_DE_ENTIDAD!= "" )

AOC_entity_count <- AOC_entity %>% 
                    group_by(TIPO_DE_ENTIDAD) %>% summarise_each(funs(sum))


# Render a bar chart with a label on the left
bar_chart <- function(label, width = "100%", height = "14px", fill = "#00bfc4", background = NULL) {
  bar <- div(style = list(background = fill, width = width, height = height))
  chart <- div(style = list(flexGrow = 1, marginLeft = "6px", background = background), bar)
  div(style = list(display = "flex", alignItems = "center"), label, chart)
}


tbl <- reactable(
  AOC_entity_count,
  pagination = TRUE,
  defaultSorted = "assigned_AOC",
  defaultColDef = colDef(headerClass = "header", align = "left"),
  columns = list(
    TIPO_DE_ENTIDAD = colDef(name = "Entity type"
 
    ),
    assigned_AOC = colDef(
      name = "Number of obs",
      defaultSortOrder = "desc",
      # Render the bar charts using a custom cell render function
      cell = function(value) {
        width <- paste0(value * 100 / max(type_entity_count$n), "%")
        # Add thousands separators
        value <- format(value, big.mark = ",")
        bar_chart(value, width = width, fill = "#3fc1c9")
      },
      # And left-align the columns
      align = "left"
    )
  )
)

tbl
```


### <b><font face="Arial" size="4px" color="#000000">Claims per type of primary class</font></b>  


```{r}

#delete special characters from TIPO_DENUNCIA_PRIMARIO_14_CLASES
clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES <- iconv(clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES, from="UTF-8",to="ASCII//TRANSLIT")


#Solving some issues with TIPO_DENUNCIA_PRIMARIO_14_CLASES
clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES <- gsub('USO INAPROPIADO DE LOS RECURSOS NO FINANCIEROS', 'USO INAPROPIADO DE RECURSOS NO FINANCIEROS', clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES)

clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES <- gsub('USO INAPROPIADO DE RECURSOS NO FINACIEROS', 'USO INAPROPIADO DE RECURSOS NO FINANCIEROS', clean_claims_21$TIPO_DENUNCIA_PRIMARIO_14_CLASES)


# number and percentage of denuncias per type of primary class
primary_class_count <- subset(clean_claims_21, TIPO_DENUNCIA_PRIMARIO_14_CLASES!= "" ) %>% 
                         count(TIPO_DENUNCIA_PRIMARIO_14_CLASES, sort = TRUE) 

primary_class_count$percentage <- round( (primary_class_count$n/sum(primary_class_count$n) )*100, 1)


# Render a bar chart with a label on the left
bar_chart <- function(label, width = "100%", height = "14px", fill = "#00bfc4", background = NULL) {
  bar <- div(style = list(background = fill, width = width, height = height))
  chart <- div(style = list(flexGrow = 1, marginLeft = "6px", background = background), bar)
  div(style = list(display = "flex", alignItems = "center"), label, chart)
}


tbl <- reactable(
  primary_class_count,
  pagination = TRUE,
  defaultSorted = "n",
  defaultColDef = colDef(headerClass = "header", align = "left"),
  columns = list(
    TIPO_DENUNCIA_PRIMARIO_14_CLASES = colDef(name = "Type of primary class"
 
    ),
    n = colDef(
      name = "Number of obs",
      defaultSortOrder = "desc",
      # Render the bar charts using a custom cell render function
      cell = function(value) {
        width <- paste0(value * 100 / max(type_entity_count$n), "%")
        # Add thousands separators
        value <- format(value, big.mark = ",")
        bar_chart(value, width = width, fill = "#3fc1c9")
      },
      # And left-align the columns
      align = "left"
    ),
    percentage = colDef(
      name = "Percentage",
      defaultSortOrder = "desc",
      # Render the bar charts using a custom cell render function
      cell = function(value) {
        # Format as percentages with 1 decimal place
        value <- paste0(format(value , nsmall = 1), "%")
        bar_chart(value, width = value, fill = "#fc5185", background = "#e1e1e1")
      },
      # And left-align the columns
      align = "left"
    )
  )
)

tbl
```


```{r, include=FALSE}

#delete special characters from DEPARTAMENTO
clean_claims_21$DEPARTAMENTO <- iconv(clean_claims_21$DEPARTAMENTO, from="UTF-8",to="ASCII//TRANSLIT")

#todo: create an interactive map (ask Marco)

#number of corruption claims by dep 
corruption_claims_dep <- subset(clean_claims_21[c("DEPARTAMENTO", "corruption_denunc")] , DEPARTAMENTO!= ""  ) 

corruption_claims_dep$corruption_denunc <- as.numeric(corruption_claims_dep$corruption_denunc)

corruption_claims_dep %>% 
   group_by(DEPARTAMENTO) %>% summarise_each(funs(sum)) 

```




Page 2
=====================================  



```{r}
names(raw_claims_feb21)
```


```{r}
table(raw_claims_feb21$estado_hec)
```



```{r, include=FALSE}
#convert all vars to string
clean_claims_21_ch <- clean_claims_21 %>%
  mutate(across(everything(), as.character))

raw_claims_feb21_ch <- raw_claims_feb21 %>%
  mutate(across(everything(), as.character))

#deleting white spaces
clean_claims_21_ch$expediente <- gsub(" ", "", clean_claims_21_ch$expediente) 
clean_claims_21_ch$fur <- gsub(" ", "", clean_claims_21_ch$fur) 
clean_claims_21_ch$numero_hec <- gsub(" ", "", clean_claims_21_ch$numero_hec) 
clean_claims_21_ch$numero_hecho <- gsub(" ", "", clean_claims_21_ch$numero_hecho) 
clean_claims_21_ch$numero_fud  <- gsub(" ", "", clean_claims_21_ch$numero_fud ) 

raw_claims_feb21_ch$expediente <- gsub(" ", "", raw_claims_feb21_ch$expediente) 
raw_claims_feb21_ch$fur <- gsub(" ", "", raw_claims_feb21_ch$fur) 
raw_claims_feb21_ch$numero_hec <- gsub(" ", "", raw_claims_feb21_ch$numero_hec) 
raw_claims_feb21_ch$numero_hecho <- gsub(" ", "", raw_claims_feb21_ch$numero_hecho) 
raw_claims_feb21_ch$numero_fud  <- gsub(" ", "", raw_claims_feb21_ch$numero_fud ) 

#from lowercase to uppercase
clean_claims_21_ch <- mutate_each(clean_claims_21_ch, funs(toupper))
raw_claims_feb21_ch <- mutate_each(raw_claims_feb21_ch, funs(toupper))

#solving issues with numero fud var
clean_claims_21_ch$numero_fud <- gsub('NAN', '', clean_claims_21_ch$numero_fud)

#creating variable that will help us with the merge
clean_claims_21_ch$clean_claims_21 <- "1"
raw_claims_feb21_ch$raw_claims_feb21 <- "1"

```

```{r, include=FALSE}
#solving issues with expediente var (deleting leading zeros)

clean_claims_21_ch$expediente <- sub("^0+", "", clean_claims_21_ch$expediente) 
raw_claims_feb21_ch$expediente <- sub("^0+", "", raw_claims_feb21_ch$expediente) 


```


```{r}
#Merge claims 21 with codified claims (todo: solve issues)

claims_21 <- merge(x = raw_claims_feb21_ch, y = clean_claims_21_ch, by = c("expediente", "fur", "numero_hec", "numero_hecho", "numero_fud"), all.x = TRUE)


nrow(claims_21)
```


```{r}
table(claims_21$clean_claims_21)
```





